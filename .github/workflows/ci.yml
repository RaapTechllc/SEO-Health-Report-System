name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install ruff
      - name: Lint
        run: ruff check . --select=E,F || true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov
          pip install -e .
          pip install -r packages/core/requirements.txt
          pip install -r packages/technical-audit/requirements.txt || true
          pip install -r packages/content-audit/requirements.txt || true
          pip install -r packages/ai-audit/requirements.txt || true
      - name: Unit tests
        run: pytest tests/unit -q --tb=short
      - name: Integration tests
        run: pytest tests/integration -q --tb=short

  e2e:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          pip install -e .
          pip install -r packages/core/requirements.txt
          pip install -r packages/technical-audit/requirements.txt || true
          pip install -r packages/content-audit/requirements.txt || true
          pip install -r packages/ai-audit/requirements.txt || true
      - name: E2E tests
        run: pytest tests/e2e -q --tb=short
        env:
          DATABASE_URL: sqlite:///./test_e2e.db
          JWT_SECRET_KEY: test-secret-key-for-ci
          TESTING: "true"

  chaos:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          pip install -e .
          pip install -r packages/core/requirements.txt
          pip install -r packages/technical-audit/requirements.txt || true
          pip install -r packages/content-audit/requirements.txt || true
          pip install -r packages/ai-audit/requirements.txt || true
      - name: Chaos tests
        run: pytest tests/chaos -v --tb=short
        env:
          DATABASE_URL: sqlite:///./test_chaos.db
          JWT_SECRET_KEY: test-secret-key-for-ci
          TESTING: "true"
        continue-on-error: true
      - name: Chaos test summary
        if: always()
        run: |
          echo "## Chaos Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Chaos tests verify system resilience under failure conditions." >> $GITHUB_STEP_SUMMARY

  smoke:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          pip install -e .
          pip install -r packages/core/requirements.txt
      - name: Smoke tests
        run: pytest tests/smoke -v --tb=short
        env:
          DATABASE_URL: sqlite:///./test_smoke.db
          JWT_SECRET_KEY: test-secret-key-for-ci
          TESTING: "true"

  verify-release:
    runs-on: ubuntu-latest
    needs: [lint, test, e2e]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest pytest-asyncio
          pip install -e .
          pip install -r packages/core/requirements.txt
          pip install -r packages/technical-audit/requirements.txt || true
          pip install -r packages/content-audit/requirements.txt || true
          pip install -r packages/ai-audit/requirements.txt || true
      - name: Verify release
        run: bash scripts/verify_release.sh

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Run lint
        run: npm run lint || true
      - name: Build
        run: npm run build
