name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}/api
  IMAGE_NAME_WORKER: ${{ github.repository }}/worker

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r packages/core/requirements.txt

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=sha-${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ steps.tag.outputs.tag }}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WORKER }}:${{ steps.tag.outputs.tag }}

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: |
          echo "Running database migrations..."
          ./scripts/run_migrations.sh upgrade

      - name: Deploy to staging
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY_STAGING }}
          PAGESPEED_API_KEY: ${{ secrets.PAGESPEED_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          APP_ENV: staging
        run: |
          echo "Deploying to staging environment..."
          # This is a placeholder for actual deployment commands
          # Replace with your deployment tool (kubectl, docker-compose, etc.)
          echo "IMAGE_TAG=${{ steps.tag.outputs.tag }}" >> deployment.env
          echo "API_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ steps.tag.outputs.tag }}" >> deployment.env
          echo "WORKER_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WORKER }}:${{ steps.tag.outputs.tag }}" >> deployment.env
          
          # Example: Docker Compose deployment
          # docker-compose -f docker-compose.staging.yml up -d
          
          # Example: Kubernetes deployment
          # kubectl set image deployment/api api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ steps.tag.outputs.tag }}
          # kubectl set image deployment/worker worker=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WORKER }}:${{ steps.tag.outputs.tag }}

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

      - name: Run smoke tests
        env:
          STAGING_URL: ${{ vars.STAGING_URL || 'http://localhost:8000' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY_STAGING }}
        run: |
          echo "Running smoke tests against staging..."
          python -m pytest tests/smoke/ -v --tb=short || true

      - name: Health check
        env:
          STAGING_URL: ${{ vars.STAGING_URL || 'http://localhost:8000' }}
        run: |
          echo "Checking health endpoint..."
          ./scripts/post_deploy_monitor.sh check ${STAGING_URL} || echo "Health check failed (continuing)"

      - name: Check metrics
        env:
          STAGING_URL: ${{ vars.STAGING_URL || 'http://localhost:8000' }}
        run: |
          echo "Checking staging metrics..."
          python3 scripts/check_metrics.py --url ${STAGING_URL} --error-threshold 10 || true

      - name: Deployment summary
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Worker Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WORKER }}:${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha || github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Staging deployment failed!"
          # Add Slack/Discord notification here if needed
