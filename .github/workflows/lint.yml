name: Lint & Type Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  ruff:
    name: Ruff Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff linting
        run: |
          ruff check . --output-format=github
        continue-on-error: false

      - name: Run Ruff format check
        run: |
          ruff format --check .
        continue-on-error: true

  mypy:
    name: MyPy Type Checking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-mypy-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install mypy types-requests types-python-dateutil

      - name: Run MyPy (packages)
        run: |
          mypy packages/ \
            --ignore-missing-imports \
            --no-error-summary \
            --show-error-codes \
            --pretty
        continue-on-error: true  # Non-blocking for now

      - name: Run MyPy (apps)
        run: |
          mypy apps/ \
            --ignore-missing-imports \
            --no-error-summary \
            --show-error-codes \
            --pretty
        continue-on-error: true  # Non-blocking for now

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          bandit -r packages/ apps/ \
            -c pyproject.toml \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --exit-zero

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Check for high/critical issues
        run: |
          HIGH_COUNT=$(cat bandit-report.json | python -c "import json,sys; data=json.load(sys.stdin); print(len([r for r in data.get('results',[]) if r.get('issue_severity','').upper() in ['HIGH','CRITICAL']]))")
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::error::Found $HIGH_COUNT high/critical security issues"
            exit 1
          fi
          echo "✅ No high/critical security issues found"

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [ruff, mypy, security]
    if: always()

    steps:
      - name: Report lint status
        run: |
          echo "## Lint & Type Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.ruff.result }}" == "success" ]; then
            echo "✅ Ruff Linting: **Passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Ruff Linting: **Failed**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.mypy.result }}" == "success" ]; then
            echo "✅ MyPy Type Check: **Passed** (non-blocking)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ MyPy Type Check: **Has Issues** (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.security.result }}" == "success" ]; then
            echo "✅ Security Scan: **Passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Security Scan: **Failed**" >> $GITHUB_STEP_SUMMARY
          fi
