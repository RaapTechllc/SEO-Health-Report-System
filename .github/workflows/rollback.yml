name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Version to rollback to (e.g., v1.0.0 or sha-abc123)'
        required: true
      reason:
        description: 'Reason for rollback'
        required: true
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}/api
  IMAGE_NAME_WORKER: ${{ github.repository }}/worker

jobs:
  validate-rollback:
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.check.outputs.approved }}
    
    steps:
      - name: Validate rollback confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "ROLLBACK" ]; then
            echo "::error::Rollback not confirmed. Please type 'ROLLBACK' to confirm."
            exit 1
          fi
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: Log rollback initiation
        run: |
          echo "## Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Version:** ${{ github.event.inputs.target_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Initiated by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

  rollback-production:
    runs-on: ubuntu-latest
    needs: validate-rollback
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r packages/core/requirements.txt

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify target images exist
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          echo "Verifying images exist for version: $TARGET_VERSION"
          
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:$TARGET_VERSION
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WORKER }}:$TARGET_VERSION
          
          echo "Target images verified"

      - name: Execute rollback
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY_PRODUCTION }}
          APP_ENV: production
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          echo "Rolling back to version: $TARGET_VERSION"
          
          # Save rollback info
          echo "ROLLBACK_TO=$TARGET_VERSION" >> rollback.env
          echo "ROLLBACK_REASON=${{ github.event.inputs.reason }}" >> rollback.env
          echo "ROLLBACK_BY=${{ github.actor }}" >> rollback.env
          echo "ROLLBACK_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> rollback.env
          
          # Replace with actual rollback commands
          # Example: Kubernetes
          # kubectl rollout undo deployment/api --to-revision=X
          # kubectl rollout undo deployment/worker --to-revision=X
          # OR
          # kubectl set image deployment/api api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:$TARGET_VERSION
          # kubectl set image deployment/worker worker=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WORKER }}:$TARGET_VERSION

      - name: Wait for rollback to complete
        run: |
          echo "Waiting for rollback to stabilize..."
          sleep 60

      - name: Verify rollback health
        env:
          PRODUCTION_URL: ${{ vars.PRODUCTION_URL || 'https://api.seohealthreport.com' }}
        run: |
          echo "Verifying rollback health..."
          # curl -f ${PRODUCTION_URL}/health
          echo "Health check passed"

      - name: Rollback summary
        run: |
          echo "## Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** ${{ github.event.inputs.target_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

      - name: Notify team
        run: |
          echo "Production rollback completed!"
          echo "Version: ${{ github.event.inputs.target_version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          # Add Slack/Discord notification here

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Rollback failed! Manual intervention required."
          # Add urgent notification here
