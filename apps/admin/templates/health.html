<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Health | RaapTech Admin</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body class="bg-raap-darker text-gray-100 min-h-screen">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-raap-primary focus:text-white focus:rounded-lg focus:outline-none focus:ring-2 focus:ring-white">Skip to content</a>
    <nav class="bg-raap-dark border-b border-raap-border" role="navigation" aria-label="Main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="/dashboard" class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-raap-primary to-raap-secondary flex items-center justify-center">
                            <span class="text-white font-bold text-lg">R</span>
                        </div>
                        <span class="text-xl font-semibold gradient-text">RaapTech SEO</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard/audits" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        Audits
                    </a>
                    <a href="/admin/health" class="text-raap-primary px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        Admin Health
                    </a>
                    <a href="/docs" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        API Docs
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" role="main">
        <div class="mb-8">
            <h1 class="text-3xl font-bold gradient-text">System Health Dashboard</h1>
            <p class="text-gray-400 mt-2">Real-time metrics â€¢ Auto-refreshes every 30 seconds</p>
            <p class="text-gray-500 text-sm mt-1">Last updated: <span id="last-updated">{{ request.scope.get('time', 'now') }}</span></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Active Audits Gauge -->
            <div class="bg-raap-card rounded-xl border border-raap-border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wide">Active Audits</h3>
                    <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                </div>
                <p id="active-audits" class="text-5xl font-bold text-raap-primary">{{ active_audits }}</p>
                <p class="text-gray-500 text-sm mt-2">Currently running</p>
            </div>

            <!-- Error Rate -->
            <div class="bg-raap-card rounded-xl border border-raap-border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wide">Error Rate</h3>
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <p id="error-rate" class="text-5xl font-bold {% if error_rate > 10 %}text-red-500{% elif error_rate > 5 %}text-yellow-500{% else %}text-raap-secondary{% endif %}">{{ error_rate }}%</p>
                <p class="text-gray-500 text-sm mt-2">Failed / Total audits</p>
            </div>

            <!-- Avg Completion Time -->
            <div class="bg-raap-card rounded-xl border border-raap-border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wide">Avg Completion Time</h3>
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p id="avg-duration" class="text-5xl font-bold text-white"><span id="avg-duration-value">{{ avg_duration_seconds }}</span><span class="text-2xl text-gray-400">s</span></p>
                <p class="text-gray-500 text-sm mt-2">Per completed audit</p>
            </div>
        </div>

        <!-- Audit Statistics -->
        <div class="mt-8 bg-raap-card rounded-xl border border-raap-border p-6">
            <h3 class="text-lg font-semibold text-white mb-6">Audit Statistics</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div class="text-center p-4 bg-raap-dark rounded-lg">
                    <p id="total-audits" class="text-3xl font-bold text-white">{{ total_audits }}</p>
                    <p class="text-gray-400 text-sm mt-1">Total Audits</p>
                </div>
                <div class="text-center p-4 bg-raap-dark rounded-lg">
                    <p id="completed-audits" class="text-3xl font-bold text-raap-secondary">{{ completed_audits }}</p>
                    <p class="text-gray-400 text-sm mt-1">Completed</p>
                </div>
                <div class="text-center p-4 bg-raap-dark rounded-lg">
                    <p id="failed-audits" class="text-3xl font-bold text-red-400">{{ failed_audits }}</p>
                    <p class="text-gray-400 text-sm mt-1">Failed</p>
                </div>
            </div>
        </div>

        <!-- Refresh Status -->
        <div class="mt-6 flex items-center justify-between text-sm text-gray-500">
            <span id="refresh-status">Auto-refresh active</span>
            <button onclick="refreshMetrics()" class="px-4 py-2 bg-raap-card border border-raap-border rounded-lg hover:bg-raap-dark transition-colors focus:outline-none focus:ring-2 focus:ring-raap-primary" aria-label="Refresh metrics now">
                Refresh Now
            </button>
        </div>
    </main>

    <footer class="border-t border-raap-border mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between text-sm text-gray-500">
                <span>RaapTech SEO Health Report System</span>
                <span>v2.0.0</span>
            </div>
        </div>
    </footer>

    <script>
        function updateErrorRateColor(rate) {
            const el = document.getElementById('error-rate');
            el.className = 'text-5xl font-bold ';
            if (rate > 10) {
                el.className += 'text-red-500';
            } else if (rate > 5) {
                el.className += 'text-yellow-500';
            } else {
                el.className += 'text-raap-secondary';
            }
        }

        async function refreshMetrics() {
            const statusEl = document.getElementById('refresh-status');
            statusEl.textContent = 'Refreshing...';
            
            try {
                const response = await fetch('/admin/health/metrics');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                document.getElementById('active-audits').textContent = data.active_audits;
                document.getElementById('error-rate').textContent = data.error_rate + '%';
                document.getElementById('avg-duration-value').textContent = data.avg_duration_seconds;
                document.getElementById('total-audits').textContent = data.total_audits;
                document.getElementById('completed-audits').textContent = data.completed_audits;
                document.getElementById('failed-audits').textContent = data.failed_audits;
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
                updateErrorRateColor(data.error_rate);
                statusEl.textContent = 'Auto-refresh active';
            } catch (error) {
                console.error('Failed to refresh metrics:', error);
                statusEl.textContent = 'Refresh failed - will retry';
            }
        }

        setInterval(refreshMetrics, 30000);
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    </script>
</body>
</html>
